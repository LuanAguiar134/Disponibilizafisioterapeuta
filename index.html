<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DisponibilizaFisio</title>
  <style>
    :root{
      --blue:#2f8fe6;
      --blue-dark:#1f6fc0;
      --orange:#ff7a00;
      --purple:#6b2aa8;
      --card-bg:#fff;
      --muted:#666;
    }
    *{box-sizing:border-box;font-family:Inter, Arial, sans-serif}
    body{
      margin:0;
      background:#f2f4f7;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    /* top header like screenshot */
    header{
      width:100%;
      background:var(--blue);
      color:#fff;
      padding:22px 12px;
      text-align:center;
    }
    header .logo{
      width:88px;
      height:88px;
      background:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      margin-bottom:10px;
    }
    header .logo img{ max-width:78px; max-height:78px; display:block; }
    header h1{ margin:6px 0 4px; font-size:20px; }
    header p.slogan{ margin:0; opacity:0.95; font-size:13px; }

    /* central container */
    .wrap{
      width:100%;
      max-width:760px;
      padding:18px;
    }
    .card{
      background:var(--card-bg);
      border-radius:8px;
      padding:16px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      border:1px solid rgba(0,0,0,0.04);
    }

    /* form styles */
    label{ display:block; font-weight:600; margin-top:8px; font-size:13px; color:#222;}
    select, input[type="text"], input[type="email"], input[type="password"], textarea{
      width:100%; padding:10px 12px; border-radius:6px; border:1px solid rgba(0,0,0,0.1); margin-top:6px; font-size:14px;
    }
    .btn{
      display:inline-block;
      padding:10px 12px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-weight:700;
    }
    .btn-blue{ background:var(--blue); color:#fff; width:100%; }
    .btn-purple{ background:var(--purple); color:#fff; width:100%; }
    .btn-orange{ background:var(--orange); color:#fff; width:100%; }
    .muted{ color:var(--muted); font-size:13px; }

    .spaced{ margin-top:12px; }
    .hidden{ display:none !important; }

    /* list items similar to print */
    .fisio-item{ margin-top:10px; padding:10px; border-radius:6px; background:#fafafa; border:1px solid rgba(0,0,0,0.03); }
    .fisio-item strong{ display:block; font-size:15px; }
    .fisio-meta{ font-size:13px; color:var(--muted); margin-top:6px; }

    .actions{ display:flex; gap:10px; margin-top:10px; }

    /* avaliação inline */
    .avaliacao-box{ margin-top:10px; border-top:1px dashed rgba(0,0,0,0.06); padding-top:10px; }
    .estrelas input[type="radio"]{ display:none; }
    .estrelas label{ color:#ccc; font-size:20px; padding:0 4px; cursor:pointer; }
    .estrelas input[type="radio"]:checked ~ label,
    .estrelas label:hover,
    .estrelas label:hover ~ label { color:gold; }

    /* small responsive */
    @media (max-width:680px){ header h1{ font-size:18px } .wrap{ padding:12px } }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="logo">
      <!-- substitui 'logo.png' pelo arquivo real quando for subir -->
      <img src="https://i.imgur.com/xG9Ixca.jpeg" alt="Logo" id="logoHeader">
    </div>
    <h1>DisponibilizaFisio</h1>
    <p class="slogan">Seu bem estar mais próximo de você!</p>
  </header>

  <div class="wrap">

    <!-- CADASTRO / LOGIN CARD -->
    <div id="cardAuth" class="card">
      <div id="authForms">
        <!-- Cadastro -->
        <div id="cadastroForm">
          <h3>Cadastro</h3>
          <form id="formCadastro">
            <label>Tipo de Usuário</label>
            <select id="tipoUsuario" required>
              <option value="paciente">Paciente</option>
              <option value="fisio">Fisioterapeuta</option>
            </select>

            <label>Nome</label>
            <input id="nome" type="text" placeholder="Digite seu nome" required>

            <label>Telefone</label>
            <input id="telefone" type="text" placeholder="(XX) XXXXX-XXXX" required>

            <div id="enderecoGroup" class="hidden">
              <label>Endereço</label>
              <input id="endereco" type="text" placeholder="Endereço">
            </div>

            <div id="servicosGroup" class="hidden">
              <label>Serviços (marque um ou mais)</label>
              <div id="listaServicos" style="margin-top:6px;"></div>
              <label style="margin-top:8px">Valor (ex: 80.00)</label>
              <input id="valorFisio" type="text" placeholder="Valor cobrado (recomendado em R$)">
            </div>

            <div id="areaPacienteGroup" class="hidden">
              <label>Área Desejada</label>
              <select id="areaPaciente">
              </select>
            </div>

            <label>Email</label>
            <input id="email" type="email" placeholder="email@exemplo.com" required>

            <label>Senha</label>
            <input id="senha" type="password" placeholder="******" required>

            <label>Confirmar Senha</label>
            <input id="confirmSenha" type="password" placeholder="******" required>

            <div class="spaced">
              <button class="btn btn-orange" type="submit">Cadastrar</button>
            </div>
          </form>
        </div>

        <hr style="margin:14px 0; border:none; border-top:1px solid rgba(0,0,0,0.06)">

        <!-- Login -->
        <div id="loginForm">
          <h3>Login</h3>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="email@exemplo.com">
          <label>Senha</label>
          <input id="loginSenha" type="password" placeholder="******">
          <div class="spaced">
            <button class="btn btn-blue" id="btnLogin">Entrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD DO PACIENTE (modelo do print) -->
    <div id="cardPaciente" class="card hidden">
      <h3 style="margin:0 0 8px 0;">Buscar Fisioterapeutas</h3>

      <label>Selecione a área de fisioterapia</label>
      <select id="selectAreaPaciente"></select>

      <div class="spaced">
        <button class="btn btn-blue" id="btnBuscar">Buscar</button>
      </div>

      <div id="listaFisioResults" style="margin-top:12px;"></div>

      <div style="margin-top:12px;">
        <button class="btn btn-purple" id="btnSairPaciente">Sair</button>
      </div>
    </div>

    <!-- DASHBOARD DO FISIOTERAPEUTA -->
    <div id="cardFisio" class="card hidden">
      <h3>Área do Fisioterapeuta</h3>
      <p id="infoFisio" class="muted"></p>

      <div id="wrapperServicosEdit" style="margin-top:10px;">
        <strong>Editar serviços</strong>
        <div id="editServicos" style="margin-top:8px;"></div>
        <label style="margin-top:8px">Valor (R$)</label>
        <input id="editValor" type="text" placeholder="Valor atual">
        <div style="margin-top:8px;">
          <button class="btn btn-blue" id="btnSalvarServicos">Salvar</button>
        </div>
      </div>

      <hr style="margin:12px 0">

      <h4>Pacientes que solicitaram atendimento</h4>
      <div id="listaSolicitacoes" style="margin-top:8px;"></div>

      <hr style="margin:12px 0">

      <h4>Avaliações recebidas</h4>
      <div id="listaAvaliacoesFisio" style="margin-top:8px;"></div>

      <div style="margin-top:12px;">
        <button class="btn btn-purple" id="btnSairFisio">Sair</button>
      </div>
    </div>

  </div>

  <script>
    /* ==========================
       Dados e utilitários
       ========================== */
    const AREAS = [
      "Acupuntura","Aquática","Cardiovascular","Dermatofuncional","Desportiva",
      "Do Trabalho","Gerontologia","Neurofuncional","Oncologia","Reumatologia",
      "Respiratória","Traumato-Ortopédica","Saúde da Mulher","Terapia Intensiva",
      "Osteopatia","Quiropraxia"
    ];

    function gerarId(){ return 'id_' + Math.random().toString(36).slice(2,9); }
    function getUsuarios(){ try{ return JSON.parse(localStorage.getItem('usuarios')) || []; }catch(e){return [];} }
    function setUsuarios(u){ localStorage.setItem('usuarios', JSON.stringify(u)); localStorage.setItem('usuarios_update_ts', Date.now().toString()); }
    function getUsuarioLogado(){ try{ return JSON.parse(localStorage.getItem('usuarioLogado')); }catch(e){return null;} }
    function setUsuarioLogado(u){ localStorage.setItem('usuarioLogado', JSON.stringify(u)); localStorage.setItem('usuarioLogado_update_ts', Date.now().toString()); }

    /* ==========================
       Elementos
       ========================== */
    const tipoUsuario = document.getElementById('tipoUsuario');
    const enderecoGroup = document.getElementById('enderecoGroup');
    const servicosGroup = document.getElementById('servicosGroup');
    const listaServicos = document.getElementById('listaServicos');
    const areaPacienteGroup = document.getElementById('areaPacienteGroup');
    const areaPaciente = document.getElementById('areaPaciente');
    const selectAreaPaciente = document.getElementById('selectAreaPaciente');

    const formCadastro = document.getElementById('formCadastro');
    const btnLogin = document.getElementById('btnLogin');
    const btnBuscar = document.getElementById('btnBuscar');

    const cardAuth = document.getElementById('cardAuth');
    const cardPaciente = document.getElementById('cardPaciente');
    const cardFisio = document.getElementById('cardFisio');

    const listaFisioResults = document.getElementById('listaFisioResults');
    const btnSairPaciente = document.getElementById('btnSairPaciente');
    const btnSairFisio = document.getElementById('btnSairFisio');

    const infoFisio = document.getElementById('infoFisio');
    const editServicos = document.getElementById('editServicos');
    const btnSalvarServicos = document.getElementById('btnSalvarServicos');
    const editValor = document.getElementById('editValor');

    const listaSolicitacoes = document.getElementById('listaSolicitacoes');
    const listaAvaliacoesFisio = document.getElementById('listaAvaliacoesFisio');

    /* ==========================
       Inicialização UI
       ========================== */
    function montarOpcoes(){
      // para cadastro do fisio: checkboxes
      listaServicos.innerHTML = '';
      AREAS.forEach(a=>{
        const id = 'chk_' + a.replace(/\s+/g,'_');
        const div = document.createElement('div');
        div.innerHTML = `<label style="font-weight:500;"><input type="checkbox" value="${a}" class="chkSrv"> <span style="margin-left:8px">${a}</span></label>`;
        listaServicos.appendChild(div);
      });

      // area paciente select
      areaPaciente.innerHTML = `<option value="">Selecione a área</option>` + AREAS.map(a=>`<option value="${a}">${a}</option>`).join('');
      selectAreaPaciente.innerHTML = `<option value="">Selecione...</option>` + AREAS.map(a=>`<option value="${a}">${a}</option>`).join('');

      // edit servicos area (for fisio dashboard)
      editServicos.innerHTML = AREAS.map(a=>`<label style="display:inline-block; margin:4px;"><input type="checkbox" class="editSrvChk" value="${a}"> <span style="margin-left:6px">${a}</span></label>`).join('');
    }
    montarOpcoes();

    // toggle campos por tipo
    tipoUsuario.addEventListener('change', ()=>{
      const t = tipoUsuario.value;
      enderecoGroup.classList.toggle('hidden', t !== 'fisio');
      servicosGroup.classList.toggle('hidden', t !== 'fisio');
      areaPacienteGroup.classList.toggle('hidden', t !== 'paciente');
    });

    /* ==========================
       CADASTRO
       ========================== */
    formCadastro.addEventListener('submit', (e)=>{
      e.preventDefault();
      const nome = document.getElementById('nome').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const senha = document.getElementById('senha').value;
      const confirmSenha = document.getElementById('confirmSenha').value;
      const tipo = tipoUsuario.value;

      if(!nome || !telefone || !email || !senha) return alert('Preencha os campos obrigatórios.');
      if(senha !== confirmSenha) return alert('Senhas não conferem.');

      const usuarios = getUsuarios();
      if(usuarios.some(u=>u.email===email)) return alert('Já existe conta com esse email.');

      const novo = {
        id: gerarId(),
        nome, telefone, email, senha, tipo,
        criadoEm: new Date().toISOString(),
        // fisio-specific:
        endereco: tipo === 'fisio' ? document.getElementById('endereco').value.trim() : '',
        servicos: tipo === 'fisio' ? Array.from(document.querySelectorAll('.chkSrv:checked')).map(c=>c.value) : [],
        valor: tipo === 'fisio' ? (document.getElementById('valorFisio').value.trim() || '') : '',
        // paciente-specific:
        areaDesejada: tipo === 'paciente' ? document.getElementById('areaPaciente').value : '',
        // relations
        solicitacoes: [], // [{pacienteId, pacienteNome, telefone, area, data}]
        avaliacoes: [] // [{nota, comentario, pacienteId, pacienteNome, data}]
      };

      usuarios.push(novo);
      setUsuarios(usuarios);
      setUsuarioLogado(novo);
      alert('Cadastro realizado com sucesso!');
      mostrarDashboard(novo);
    });

    /* ==========================
       LOGIN
       ========================== */
    btnLogin.addEventListener('click', ()=>{
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();
      const senha = document.getElementById('loginSenha').value;
      const usuarios = getUsuarios();
      const user = usuarios.find(u=>u.email===email && u.senha===senha);
      if(!user) return alert('Email ou senha incorretos.');
      setUsuarioLogado(user);
      mostrarDashboard(user);
    });

    /* ==========================
       DASHBOARD mostrar
       ========================== */
    function mostrarDashboard(user){
      cardAuth.classList.add('hidden');
      listaFisioResults.innerHTML = '';
      if(user.tipo === 'paciente'){
        cardFisio.classList.add('hidden');
        cardPaciente.classList.remove('hidden');
        // pre-seleciona a area do paciente se tiver
        if(user.areaDesejada) selectAreaPaciente.value = user.areaDesejada;
        else selectAreaPaciente.value = '';
        // atualizar lista conforme area atual (se quiser já listar)
        // render lista vazia até buscar
        listaFisioResults.innerHTML = '';
      } else {
        // fisio
        cardPaciente.classList.add('hidden');
        cardFisio.classList.remove('hidden');
        renderFisioDashboard(user);
      }
    }

    /* ==========================
       PACIENTE: Buscar e listar
       ========================== */
    btnBuscar.addEventListener('click', ()=>{
      const area = selectAreaPaciente.value;
      if(!area) return alert('Escolha uma área.');
      // atualizar paciente logado areaDesejada
      const user = getUsuarioLogado();
      if(user && user.tipo === 'paciente'){
        // persiste a area escolhida para o paciente
        const usuarios = getUsuarios();
        const idx = usuarios.findIndex(u=>u.id===user.id);
        if(idx>=0){ usuarios[idx].areaDesejada = area; setUsuarios(usuarios); setUsuarioLogado(usuarios[idx]); }
      }
      listarFisioterapeutas(area);
    });

    function listarFisioterapeutas(area){
      listaFisioResults.innerHTML = '';
      const usuarios = getUsuarios();
      const fisios = usuarios.filter(u=>u.tipo==='fisio' && u.servicos && u.servicos.includes(area));
      if(!fisios.length){
        listaFisioResults.innerHTML = '<p class="muted">Nenhum fisioterapeuta disponível nesta área no momento.</p>';
        return;
      }
      // montar lista
      fisios.forEach(f=>{
        const item = document.createElement('div');
        item.className = 'fisio-item';
        const precoFormat = f.valor ? ` (R$ ${Number(String(f.valor).replace(',','.')).toFixed(2)})` : '';
        item.innerHTML = `<strong>${f.nome} - ${f.telefone}${precoFormat} <span style="font-weight:600; margin-left:8px">[${f.servicos.join(', ')}]</span></strong>
                          <div class="fisio-meta">${f.endereco ? f.endereco + ' · ' : ''}${f.email}</div>
                          <div class="actions">
                            <button class="btn btn-blue" onclick="solicitarAtendimento('${f.id}')">Solicitar Atendimento</button>
                            <button class="btn btn-orange" onclick="abrirAvaliacaoInline('${f.id}', this)">Avaliar</button>
                          </div>
                          <div id="avaliacao_box_${f.id}" class="avaliacao-box hidden"></div>`;
        listaFisioResults.appendChild(item);

        // se paciente já solicitou, pode avaliar — mostramos mensagem para avaliar
        const usuarioLogado = getUsuarioLogado();
        if(usuarioLogado && usuarioLogado.tipo === 'paciente'){
          const jaSolicitou = (f.solicitacoes || []).some(s=>s.pacienteId === usuarioLogado.id);
          const avalBox = item.querySelector(`#avaliacao_box_${f.id}`);
          if(jaSolicitou){
            // opcional: auto mostrar avaliação area (mas vamos manter oculta até clicar Avaliar)
            // avalBox.classList.remove('hidden');
          } else {
            // bloqueia avaliar até solicitar: alterar botão Avaliar para aviso ao clicar
            // handled in abrirAvaliacaoInline
          }
        }
      });
    }

    /* ==========================
       Solicitação atendimento
       ========================== */
    window.solicitarAtendimento = function(fisioId){
      const user = getUsuarioLogado();
      if(!user || user.tipo !== 'paciente') return alert('Apenas pacientes podem solicitar atendimento.');
      const usuarios = getUsuarios();
      const idxF = usuarios.findIndex(u=>u.id===fisioId);
      if(idxF < 0) return alert('Fisioterapeuta não encontrado.');

      // verifica se já solicitou
      const ja = (usuarios[idxF].solicitacoes || []).some(s => s.pacienteId === user.id);
      if(ja) return alert('Você já solicitou atendimento a este fisioterapeuta.');

      const sol = {
        pacienteId: user.id,
        pacienteNome: user.nome,
        telefone: user.telefone,
        area: user.areaDesejada || selectAreaPaciente.value || 'Não informada',
        data: new Date().toISOString()
      };
      usuarios[idxF].solicitacoes = usuarios[idxF].solicitacoes || [];
      usuarios[idxF].solicitacoes.push(sol);
      setUsuarios(usuarios);
      alert('Solicitação enviada com sucesso. Agora você pode avaliar após o atendimento.');
      // re-render a lista para atualizar estado dos botões
      const area = selectAreaPaciente.value || user.areaDesejada;
      if(area) listarFisioterapeutas(area);
    };

    /* ==========================
       Avaliação inline (no card paciente)
       ========================== */
    window.abrirAvaliacaoInline = function(fisioId, btnEl){
      const usuario = getUsuarioLogado();
      if(!usuario || usuario.tipo !== 'paciente') return alert('Apenas pacientes podem avaliar.');
      const usuarios = getUsuarios();
      const f = usuarios.find(u=>u.id===fisioId);
      if(!f) return alert('Fisioterapeuta não encontrado.');

      // verifica se paciente solicitou atendimento antes de permitir avaliação
      const jaSolicitou = (f.solicitacoes || []).some(s => s.pacienteId === usuario.id);
      if(!jaSolicitou){
        // perguntar se quer solicitar agora
        if(confirm('Você ainda não solicitou atendimento a este profissional. Deseja solicitar agora antes de avaliar?')){
          solicitarAtendimento(fisioId);
        } else {
          return;
        }
      }

      const box = document.getElementById(`avaliacao_box_${fisioId}`);
      // montar formulário de avaliação
      box.innerHTML = `
        <div style="font-weight:600; margin-bottom:6px;">Avaliar ${f.nome}</div>
        <div class="estrelas" style="display:flex; flex-direction:row-reverse; justify-content:flex-start;">
          <input type="radio" name="estrela_${fisioId}" id="estrela_${fisioId}_5" value="5"><label for="estrela_${fisioId}_5">★</label>
          <input type="radio" name="estrela_${fisioId}" id="estrela_${fisioId}_4" value="4"><label for="estrela_${fisioId}_4">★</label>
          <input type="radio" name="estrela_${fisioId}" id="estrela_${fisioId}_3" value="3"><label for="estrela_${fisioId}_3">★</label>
          <input type="radio" name="estrela_${fisioId}" id="estrela_${fisioId}_2" value="2"><label for="estrela_${fisioId}_2">★</label>
          <input type="radio" name="estrela_${fisioId}" id="estrela_${fisioId}_1" value="1"><label for="estrela_${fisioId}_1">★</label>
        </div>
        <textarea id="comentario_${fisioId}" rows="3" style="width:100%; margin-top:8px;" placeholder="Deixe um comentário..."></textarea>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn btn-orange" onclick="enviarAvaliacao('${fisioId}')">Enviar Avaliação</button>
          <button class="btn btn-purple" onclick="fecharAvaliacao('${fisioId}')">Fechar</button>
        </div>
      `;
      box.classList.remove('hidden');
      // scroll to box for better UX on mobile
      box.scrollIntoView({behavior:'smooth', block:'center'});
    };

    window.fecharAvaliacao = function(fisioId){
      const box = document.getElementById(`avaliacao_box_${fisioId}`);
      if(box){ box.classList.add('hidden'); box.innerHTML = ''; }
    };

    window.enviarAvaliacao = function(fisioId){
      const usuario = getUsuarioLogado();
      if(!usuario || usuario.tipo !== 'paciente') return alert('Apenas pacientes podem avaliar.');
      const notaInput = document.querySelector(`input[name="estrela_${fisioId}"]:checked`);
      if(!notaInput) return alert('Selecione a quantidade de estrelas.');
      const nota = Number(notaInput.value);
      const comentario = document.getElementById(`comentario_${fisioId}`).value.trim();

      const usuarios = getUsuarios();
      const idxF = usuarios.findIndex(u=>u.id===fisioId);
      if(idxF < 0) return alert('Fisioterapeuta não encontrado.');

      // checar se paciente já solicitou (requisito)
      const f = usuarios[idxF];
      const solicitou = (f.solicitacoes || []).some(s => s.pacienteId === usuario.id);
      if(!solicitou) return alert('Somente pacientes que solicitaram atendimento podem avaliar.');

      const aval = {
        nota, comentario, pacienteId: usuario.id, pacienteNome: usuario.nome, data: new Date().toISOString()
      };
      usuarios[idxF].avaliacoes = usuarios[idxF].avaliacoes || [];
      usuarios[idxF].avaliacoes.push(aval);
      setUsuarios(usuarios);
      alert('Avaliação enviada com sucesso. Obrigado!');
      fecharAvaliacao(fisioId);
      // atualizar a visualização (mantém paciente no card)
      const area = selectAreaPaciente.value || usuario.areaDesejada;
      if(area) listarFisioterapeutas(area);
    };

    /* ==========================
       FISIO: Dashboard, editar serviços, solicitações e avaliações
       ========================== */
    function renderFisioDashboard(fisioUser){
      const usuarios = getUsuarios();
      const f = usuarios.find(u=>u.id===fisioUser.id) || fisioUser;
      infoFisio.innerHTML = `<strong>${f.nome}</strong><br><span class="muted">${f.servicos && f.servicos.length ? f.servicos.join(', ') : 'Nenhum serviço cadastrado'}</span><br><span class="muted">Valor: ${f.valor ? 'R$ ' + Number(String(f.valor).replace(',','.')).toFixed(2) : 'Não informado'}</span>`;

      // preencher checkboxes editServicos com os servicos atuais
      Array.from(document.querySelectorAll('.editSrvChk')).forEach(ch=>{
        ch.checked = (f.servicos || []).includes(ch.value);
      });
      editValor.value = f.valor || '';

      // listar solicitacoes
      listaSolicitacoes.innerHTML = '';
      if(!f.solicitacoes || f.solicitacoes.length === 0){
        listaSolicitacoes.innerHTML = '<p class="muted">Nenhum paciente solicitou atendimento ainda.</p>';
      } else {
        f.solicitacoes.forEach(s=>{
          const div = document.createElement('div');
          div.className = 'fisio-item';
          div.innerHTML = `<strong>${s.pacienteNome}</strong><div class="muted">${s.telefone} · ${s.area}</div>
                           <div style="margin-top:8px;"><button class="btn btn-orange" onclick="marcarAtendido('${f.id}','${s.pacienteId}')">Marcar como atendido</button></div>`;
          listaSolicitacoes.appendChild(div);
        });
      }

      // listar avaliacoes recebidas
      listaAvaliacoesFisio.innerHTML = '';
      if(!f.avaliacoes || f.avaliacoes.length === 0){
        listaAvaliacoesFisio.innerHTML = '<p class="muted">Nenhuma avaliação recebida ainda.</p>';
      } else {
        // mostrar do mais recente
        const reversed = f.avaliacoes.slice().reverse();
        reversed.forEach(a=>{
          const div = document.createElement('div');
          div.className = 'fisio-item';
          div.innerHTML = `<strong>${a.pacienteNome} — ${a.nota}★</strong><div class="muted">${new Date(a.data).toLocaleString()}</div>
                           <div style="margin-top:8px;">${a.comentario ? `<div>${a.comentario}</div>` : ''}</div>`;
          listaAvaliacoesFisio.appendChild(div);
        });
      }
    }

    btnSalvarServicos.addEventListener('click', ()=>{
      const user = getUsuarioLogado();
      if(!user || user.tipo !== 'fisio') return;
      const usuarios = getUsuarios();
      const idx = usuarios.findIndex(u=>u.id===user.id);
      if(idx < 0) return;
      const servs = Array.from(document.querySelectorAll('.editSrvChk:checked')).map(c=>c.value);
      usuarios[idx].servicos = servs;
      usuarios[idx].valor = editValor.value.trim();
      setUsuarios(usuarios);
      setUsuarioLogado(usuarios[idx]);
      alert('Serviços e valor atualizados.');
      renderFisioDashboard(usuarios[idx]);
    });

    window.marcarAtendido = function(fisioId, pacienteId){
      const usuarios = getUsuarios();
      const idx = usuarios.findIndex(u=>u.id===fisioId);
      if(idx<0) return;
      usuarios[idx].solicitacoes = (usuarios[idx].solicitacoes || []).filter(s=>s.pacienteId !== pacienteId);
      setUsuarios(usuarios);
      // atualizar logado
      const log = getUsuarioLogado();
      if(log && log.id === fisioId) setUsuarioLogado(usuarios[idx]);
      renderFisioDashboard(usuarios[idx]);
    };

    /* ==========================
       Logout
       ========================== */
    btnSairPaciente.addEventListener('click', ()=>{
      localStorage.removeItem('usuarioLogado');
      location.reload();
    });
    btnSairFisio.addEventListener('click', ()=>{
      localStorage.removeItem('usuarioLogado');
      location.reload();
    });

    /* ==========================
       Ao carregar: restore sessão
       ========================== */
    window.addEventListener('load', ()=>{
      const user = getUsuarioLogado();
      if(user){
        // obter versão atualizada do storage
        const usuarios = getUsuarios();
        const fresh = usuarios.find(u=>u.email===user.email) || user;
        setUsuarioLogado(fresh);
        mostrarDashboard(fresh);
      } else {
        // mostrar auth card (padrão)
        cardAuth.classList.remove('hidden');
      }
    });

    /* ==========================
       Sincronização entre abas (quando novos fisioterapeutas se cadastram)
       ========================== */
    window.addEventListener('storage', (ev)=>{
      if(ev.key === 'usuarios' || ev.key === 'usuarios_update_ts' || ev.key === 'usuarioLogado_update_ts'){
        const user = getUsuarioLogado();
        if(!user) return;
        const usuarios = getUsuarios();
        const fresh = usuarios.find(u=>u.email===user.email) || user;
        setUsuarioLogado(fresh);
        // re-render conforme tipo
        if(fresh.tipo === 'paciente'){
          // re-render paciente list if currently visible & same area
          const area = selectAreaPaciente.value || fresh.areaDesejada;
          if(area) listarFisioterapeutas(area);
        } else {
          renderFisioDashboard(fresh);
        }
      }
    });

    /* ==========================
       Expor funções para debug (opcional)
       ========================== */
    window._DF = { getUsuarios, setUsuarios, getUsuarioLogado, setUsuarioLogado };

  </script>
</body>
</html>
