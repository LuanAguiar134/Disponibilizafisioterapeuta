<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DisponibilizaFisio — Cadastro / Login</title>
  <style>
    /* Reset simples */
    * { box-sizing: border-box; font-family: Inter, system-ui, Arial, sans-serif; }
    body {
      background: #ffffff;
      color: #222;
      margin: 0;
      padding: 40px 12px;
      display: flex;
      justify-content: center;
    }

    /* Card central */
    .card {
      width: 420px;
      max-width: 96%;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      padding: 22px;
      border: 1px solid rgba(0,0,0,0.04);
    }
    h1 { text-align: center; margin: 2px 0 14px; font-size: 22px; }
    label { display:block; font-weight:600; margin-top:10px; font-size:13px; color:#333; }
    input[type="text"], input[type="email"], input[type="password"], select, textarea {
      width:100%;
      padding:10px 12px;
      margin-top:6px;
      border-radius:6px;
      border:1px solid rgba(0,0,0,0.12);
      font-size:14px;
    }
    .row { display:flex; gap:10px; }
    .hidden { display:none !important; }

    .orange-btn {
      background: #ff7a00;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius:6px;
      font-weight:700;
      cursor:pointer;
      width:100%;
      margin-top:12px;
    }
    .small-link {
      display:block;
      text-align:center;
      margin-top:8px;
      color:#2b6ebd;
      font-size:13px;
      text-decoration:underline;
      cursor:pointer;
    }
    hr { border: none; border-top:1px solid rgba(0,0,0,0.08); margin:14px 0; }

    /* Dashboard */
    .dashboard-container h2 { margin:4px 0 6px; font-size:18px; text-align:center; }
    .info { font-size:14px; margin-bottom:8px; text-align:center; color:#444; }

    .fisio-card, .paciente-card {
      border:1px solid rgba(0,0,0,0.06);
      padding:10px 12px;
      border-radius:8px;
      margin-bottom:10px;
    }
    .fisio-card h4 { margin:4px 0; }
    .list-item { margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed rgba(0,0,0,0.04); }
    .actions { display:flex; gap:8px; margin-top:8px; }

    /* Avaliação */
    .avaliacao-container { margin-top: 10px; padding-top:10px; border-top:1px solid rgba(0,0,0,0.06); }
    .estrelas input[type="radio"] { display: none; }
    .estrelas label {
      color: #ccc;
      font-size: 22px;
      padding: 0 5px;
      cursor: pointer;
    }
    .estrelas input[type="radio"]:checked ~ label,
    .estrelas label:hover,
    .estrelas label:hover ~ label {
      color: gold;
    }
    .muted { color:#666; font-size:13px; }

    /* Small controls */
    .inline { display:inline-block; vertical-align:middle; }
    .chip { display:inline-block; padding:6px 8px; background:#f7f7f7; border-radius:999px; margin:3px; font-size:13px; border:1px solid rgba(0,0,0,0.04); }
    .edit-btn { background:#eee; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; }

    /* Responsividade */
    @media (max-width:480px) {
      body { padding:24px 10px; }
      .card { padding:16px; }
    }
  </style>
</head>
<body>
  <div class="card" id="cadastro">
    <h1>DisponibilizaFisio</h1>

    <!-- Form de cadastro -->
    <form id="formCadastro">
      <label for="tipoUsuario">Tipo de Usuário</label>
      <select id="tipoUsuario" required>
        <option value="paciente">Paciente</option>
        <option value="fisio">Fisioterapeuta</option>
      </select>

      <label for="nome">Nome</label>
      <input id="nome" type="text" placeholder="Digite seu nome" required>

      <label for="telefone">Telefone</label>
      <input id="telefone" type="text" placeholder="(XX) XXXXX-XXXX" required>

      <!-- Fisio fields -->
      <div id="enderecoGroup" class="hidden">
        <label for="endereco">Endereço</label>
        <input id="endereco" type="text" placeholder="Endereço (opcional)">
      </div>

      <div id="especializacaoGroup" class="hidden">
        <label for="especializacaoFisio">Selecione suas áreas/serviços (múltipla escolha)</label>
        <div id="listaServicosFisio" style="margin-top:6px;">
          <!-- checkboxes geradas por JS -->
        </div>
      </div>

      <!-- Paciente area -->
      <div id="areaPacienteGroup" class="hidden">
        <label for="areaPaciente">Área Desejada</label>
        <select id="areaPaciente">
          <!-- options geradas por JS -->
        </select>
      </div>

      <label for="email">Email</label>
      <input id="email" type="email" placeholder="email@exemplo.com" required>

      <label for="senha">Senha</label>
      <input id="senha" type="password" placeholder="******" required>

      <label for="confirmSenha">Confirmar Senha</label>
      <input id="confirmSenha" type="password" placeholder="******" required>

      <button class="orange-btn" type="submit">Cadastrar</button>
    </form>

    <hr>

    <!-- Login -->
    <label for="loginEmail">Email</label>
    <input id="loginEmail" type="email" placeholder="email@exemplo.com">

    <label for="loginSenha">Senha</label>
    <input id="loginSenha" type="password" placeholder="******">

    <button class="orange-btn" id="btnLogin">Entrar</button>

    <a class="small-link" id="esqueci">Esqueceu a senha?</a>
  </div>

  <!-- Dashboard (visível após login) -->
  <div class="card hidden" id="dashboard">
    <h2>Bem-vindo(a), <span id="nomeUsuario"></span></h2>
    <p class="info"><strong>Tipo:</strong> <span id="tipoUsuarioDash"></span></p>
    <p class="muted" id="infoExtraDash"></p>

    <div id="conteudoDinamico"></div>

    <!-- Avaliação reusável (aparece na tela do paciente quando visualiza um fisioterapeuta) -->
    <div class="avaliacao-container hidden" id="avaliacaoContainer">
      <h3>Avaliar Fisioterapeuta</h3>
      <div class="estrelas" id="estrelasWrapper">
        <input type="radio" name="estrela" id="estrela5" value="5"><label for="estrela5">★</label>
        <input type="radio" name="estrela" id="estrela4" value="4"><label for="estrela4">★</label>
        <input type="radio" name="estrela" id="estrela3" value="3"><label for="estrela3">★</label>
        <input type="radio" name="estrela" id="estrela2" value="2"><label for="estrela2">★</label>
        <input type="radio" name="estrela" id="estrela1" value="1"><label for="estrela1">★</label>
      </div>
      <textarea id="comentarioAvaliacao" rows="3" style="width:100%; margin-top:8px;" placeholder="Deixe um comentário..."></textarea>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="orange-btn" id="btnEnviarAvaliacao" style="flex:1">Enviar Avaliação</button>
        <button class="edit-btn" id="btnCancelarAvaliacao">Cancelar</button>
      </div>
    </div>

    <div style="margin-top:12px;">
      <button class="orange-btn" id="btnLogout">Sair</button>
    </div>
  </div>

  <script>
    /***********************
     * Dados e utilitários
     ***********************/
    const AREAS = [
      "Acupuntura","Aquática","Cardiovascular","Dermatofuncional","Desportiva",
      "Do Trabalho","Gerontologia","Neurofuncional","Oncologia","Reumatologia",
      "Respiratória","Traumato-Ortopédica","Saúde da Mulher","Terapia Intensiva",
      "Osteopatia","Quiropraxia"
    ];

    function gerarId() {
      return 'id_' + Math.random().toString(36).slice(2,9);
    }

    function getUsuarios() {
      return JSON.parse(localStorage.getItem('usuarios')) || [];
    }
    function setUsuarios(u) {
      localStorage.setItem('usuarios', JSON.stringify(u));
    }
    function salvarUsuarioLogado(u) {
      localStorage.setItem('usuarioLogado', JSON.stringify(u));
    }
    function pegarUsuarioLogado() {
      return JSON.parse(localStorage.getItem('usuarioLogado'));
    }

    /***********************
     * Inicialização UI
     ***********************/
    const tipoUsuario = document.getElementById('tipoUsuario');
    const enderecoGroup = document.getElementById('enderecoGroup');
    const especializacaoGroup = document.getElementById('especializacaoGroup');
    const areaPacienteGroup = document.getElementById('areaPacienteGroup');
    const listaServicosFisio = document.getElementById('listaServicosFisio');
    const areaPacienteSelect = document.getElementById('areaPaciente');

    // Preenche lista de áreas para fisio (checkboxes) e para paciente (select)
    function montarOpcoesAreas() {
      // fisio: checkboxes
      listaServicosFisio.innerHTML = '';
      AREAS.forEach(a => {
        const id = 'serv_'+a.replace(/\s+/g,'_');
        const wrapper = document.createElement('div');
        wrapper.style.marginBottom = '6px';
        wrapper.innerHTML = `<label style="font-weight:500;"><input type="checkbox" value="${a}" class="chkServico"> <span style="margin-left:8px;">${a}</span></label>`;
        listaServicosFisio.appendChild(wrapper);
      });

      // paciente select
      areaPacienteSelect.innerHTML = '';
      AREAS.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a;
        opt.textContent = a;
        areaPacienteSelect.appendChild(opt);
      });
    }
    montarOpcoesAreas();

    // toggles de visibilidade conforme tipo selecionado
    tipoUsuario.addEventListener('change', () => {
      const tipo = tipoUsuario.value;
      enderecoGroup.classList.toggle('hidden', tipo !== 'fisio');
      especializacaoGroup.classList.toggle('hidden', tipo !== 'fisio');
      areaPacienteGroup.classList.toggle('hidden', tipo !== 'paciente');
    });

    /***********************
     * Cadastro
     ***********************/
    const formCadastro = document.getElementById('formCadastro');
    formCadastro.addEventListener('submit', (e) => {
      e.preventDefault();
      const nome = document.getElementById('nome').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const endereco = document.getElementById('endereco').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const senha = document.getElementById('senha').value;
      const confirmSenha = document.getElementById('confirmSenha').value;
      const tipo = document.getElementById('tipoUsuario').value;

      if (!nome || !telefone || !email || !senha) {
        alert('Preencha todos os campos obrigatórios.');
        return;
      }
      if (senha !== confirmSenha) {
        alert('Senhas não conferem.');
        return;
      }

      const usuarios = getUsuarios();
      if (usuarios.some(u => u.email === email)) {
        alert('Já existe uma conta com esse email.');
        return;
      }

      const novo = {
        id: gerarId(),
        nome,
        telefone,
        email,
        senha,
        tipo,
        criadoEm: new Date().toISOString(),
        // campos específicos
        endereco: tipo === 'fisio' ? endereco : '',
        servicos: tipo === 'fisio' ? Array.from(document.querySelectorAll('.chkServico:checked')).map(c => c.value) : [],
        areaDesejada: tipo === 'paciente' ? document.getElementById('areaPaciente').value : '',
        // estruturas para relacionamentos/ratings
        solicitacoes: [], // para fisioterapeuta: lista de {pacienteId, pacienteNome, telefone, area}
        avaliacoes: [] // para fisioterapeuta: lista de {nota, comentario, pacienteId, pacienteNome, data}
      };

      usuarios.push(novo);
      setUsuarios(usuarios);
      salvarUsuarioLogado(novo);
      mostrarDashboard(novo);
    });

    /***********************
     * Login
     ***********************/
    const btnLogin = document.getElementById('btnLogin');
    btnLogin.addEventListener('click', () => {
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();
      const senha = document.getElementById('loginSenha').value;
      const usuarios = getUsuarios();
      const user = usuarios.find(u => u.email === email && u.senha === senha);
      if (!user) {
        alert('Email ou senha inválidos.');
        return;
      }
      salvarUsuarioLogado(user);
      mostrarDashboard(user);
    });

    /***********************
     * Dashboard
     ***********************/
    const cardCadastro = document.getElementById('cadastro');
    const dashboard = document.getElementById('dashboard');
    const nomeUsuarioSpan = document.getElementById('nomeUsuario');
    const tipoUsuarioDash = document.getElementById('tipoUsuarioDash');
    const infoExtraDash = document.getElementById('infoExtraDash');
    const conteudoDinamico = document.getElementById('conteudoDinamico');
    const avaliacaoContainer = document.getElementById('avaliacaoContainer');
    const comentarioAvaliacao = document.getElementById('comentarioAvaliacao');
    const btnEnviarAvaliacao = document.getElementById('btnEnviarAvaliacao');
    const btnCancelarAvaliacao = document.getElementById('btnCancelarAvaliacao');

    let fisioterapeutaVisualizando = null; // id do fisio que paciente está avaliando

    function mostrarDashboard(usuario) {
      cardCadastro.classList.add('hidden');
      dashboard.classList.remove('hidden');
      nomeUsuarioSpan.textContent = usuario.nome;
      tipoUsuarioDash.textContent = usuario.tipo === 'fisio' ? 'Fisioterapeuta' : 'Paciente';
      avaliacaoContainer.classList.add('hidden');
      comentarioAvaliacao.value = '';

      if (usuario.tipo === 'fisio') {
        infoExtraDash.innerHTML = `<strong>Serviços:</strong> ${usuario.servicos && usuario.servicos.length ? usuario.servicos.join(', ') : 'Nenhum cadastrado'}<br><strong>Endereço:</strong> ${usuario.endereco || 'Não informado'}`;
        renderFisioDashboard(usuario);
      } else {
        infoExtraDash.innerHTML = `<strong>Área desejada:</strong> ${usuario.areaDesejada || 'Não informada'}`;
        renderPacienteDashboard(usuario);
      }
    }

    // Render paciente: lista fisioterapeutas da área + controlar solicitações e avaliações
    function renderPacienteDashboard(paciente) {
      const usuarios = getUsuarios();
      const area = paciente.areaDesejada;
      let html = '';
      // permite trocar de area
      html += `<div style="margin-bottom:10px;"><strong>Alterar área desejada:</strong><div style="display:flex; gap:8px; margin-top:6px;">
        <select id="trocaAreaSelect" style="flex:1;">${AREAS.map(a=>`<option value="${a}" ${a===area?'selected':''}>${a}</option>`).join('')}</select>
        <button class="edit-btn" id="btnSalvarArea">Salvar</button>
      </div></div>`;

      // listar fisioterapeutas que tenham serviço na área
      const fisios = usuarios.filter(u => u.tipo === 'fisio' && u.servicos && u.servicos.includes(area));
      html += `<h3>Fisioterapeutas disponíveis para: <em>${area || '—'}</em></h3>`;
      if (!fisios.length) {
        html += `<p class="muted">Nenhum fisioterapeuta encontrado nesta área.</p>`;
      } else {
        fisios.forEach(f => {
          const media = calcularMediaAvaliacoes(f.avaliacoes);
          html += `<div class="fisio-card list-item">
            <h4>${f.nome}</h4>
            <div class="muted">Serviços: ${f.servicos.join(', ')}</div>
            <div class="muted">Endereço: ${f.endereco || 'Não informado'}</div>
            <div style="margin-top:8px;"><strong>Avaliação:</strong> ${media.mediaFormat}</div>
            <div class="actions">
              <button class="orange-btn" onclick="solicitarAtendimento('${f.id}')">Solicitar Atendimento</button>
              <button class="edit-btn" onclick="verPerfilFisio('${f.id}')">Ver Perfil / Avaliar</button>
            </div>
          </div>`;
        });
      }
      conteudoDinamico.innerHTML = html;

      // eventos dinâmicos
      document.getElementById('btnSalvarArea').addEventListener('click', () => {
        const novoArea = document.getElementById('trocaAreaSelect').value;
        if (!novoArea) return;
        // atualizar paciente na storage
        const usuariosAll = getUsuarios();
        const idx = usuariosAll.findIndex(u => u.email === paciente.email);
        if (idx >= 0) {
          usuariosAll[idx].areaDesejada = novoArea;
          setUsuarios(usuariosAll);
          salvarUsuarioLogado(usuariosAll[idx]);
          mostrarDashboard(usuariosAll[idx]);
          alert('Área alterada com sucesso.');
        }
      });
    }

    // Render fisioterapeuta: ver solicitações (apenas pacientes que solicitaram) + editar serviços
    function renderFisioDashboard(fisio) {
      const usuarios = getUsuarios();
      let html = '';

      // botão editar serviços
      html += `<div style="margin-bottom:10px;">
        <strong>Editar seus serviços:</strong>
        <div style="margin-top:8px;" id="editarServicosWrapper">${AREAS.map(a=>{
          const checked = (fisio.servicos || []).includes(a) ? 'checked' : '';
          return `<label style="display:inline-block; margin:4px;"><input type="checkbox" class="editServicoChk" value="${a}" ${checked}> <span style="margin-left:6px;">${a}</span></label>`;
        }).join('')}</div>
        <div style="margin-top:8px;"><button class="edit-btn" id="btnSalvarServicos">Salvar Serviços</button></div>
      </div>`;

      // lista de solicitações
      html += `<h3>Pacientes que solicitaram atendimento</h3>`;
      if (!fisio.solicitacoes || !fisio.solicitacoes.length) {
        html += `<p class="muted">Nenhum paciente solicitou atendimento ainda.</p>`;
      } else {
        fisio.solicitacoes.forEach(s => {
          html += `<div class="paciente-card list-item">
            <div><strong>${s.pacienteNome}</strong> <span class="muted">(${s.area})</span></div>
            <div class="muted">Telefone: ${s.telefone || 'Não informado'}</div>
            <div style="margin-top:8px;">
              <button class="edit-btn" onclick="marcarComoAtendido('${fisio.id}','${s.pacienteId}')">Marcar como atendido</button>
            </div>
          </div>`;
        });
      }

      // avaliações recebidas
      html += `<h3 style="margin-top:10px;">Avaliações recebidas</h3>`;
      if (!fisio.avaliacoes || !fisio.avaliacoes.length) {
        html += `<p class="muted">Nenhuma avaliação ainda.</p>`;
      } else {
        fisio.avaliacoes.slice().reverse().forEach(a => {
          html += `<div class="list-item">
            <div><strong>${a.pacienteNome}</strong> — ${a.nota}★ <span class="muted">(${new Date(a.data).toLocaleString()})</span></div>
            ${a.comentario ? `<div style="margin-top:6px;">${a.comentario}</div>` : ''}
          </div>`;
        });
      }

      conteudoDinamico.innerHTML = html;

      // eventos
      document.getElementById('btnSalvarServicos').addEventListener('click', () => {
        const selecionadas = Array.from(document.querySelectorAll('.editServicoChk:checked')).map(c=>c.value);
        const usuariosAll = getUsuarios();
        const idx = usuariosAll.findIndex(u => u.id === fisio.id);
        if (idx >= 0) {
          usuariosAll[idx].servicos = selecionadas;
          setUsuarios(usuariosAll);
          salvarUsuarioLogado(usuariosAll[idx]);
          mostrarDashboard(usuariosAll[idx]);
          alert('Serviços atualizados.');
        }
      });
    }

    function calcularMediaAvaliacoes(avaliacoes) {
      if (!avaliacoes || !avaliacoes.length) return {media:0, mediaFormat: 'Sem avaliações'};
      const soma = avaliacoes.reduce((s,a) => s + Number(a.nota), 0);
      const media = soma / avaliacoes.length;
      return {media, mediaFormat: `${media.toFixed(1)} (${avaliacoes.length} avaliação${avaliacoes.length>1?'es':''})`};
    }

    /***********************
     * Solicitação e perfil do fisio
     ***********************/
    window.solicitarAtendimento = function(fisioId) {
      const usuarioLogado = pegarUsuarioLogado();
      if (!usuarioLogado || usuarioLogado.tipo !== 'paciente') {
        alert('Apenas pacientes podem solicitar atendimento.');
        return;
      }
      const usuarios = getUsuarios();
      const idxF = usuarios.findIndex(u => u.id === fisioId);
      if (idxF < 0) return alert('Fisioterapeuta não encontrado.');

      // verifica se já solicitou
      const ja = usuarios[idxF].solicitacoes && usuarios[idxF].solicitacoes.some(s => s.pacienteId === usuarioLogado.id);
      if (ja) {
        return alert('Você já solicitou atendimento a este fisioterapeuta.');
      }
      // adiciona solicitação
      const sol = {
        pacienteId: usuarioLogado.id,
        pacienteNome: usuarioLogado.nome,
        telefone: usuarioLogado.telefone,
        area: usuarioLogado.areaDesejada || 'Não informada',
        data: new Date().toISOString()
      };
      usuarios[idxF].solicitacoes = usuarios[idxF].solicitacoes || [];
      usuarios[idxF].solicitacoes.push(sol);
      setUsuarios(usuarios);
      alert('Solicitação enviada com sucesso. O fisioterapeuta poderá ver seus dados de contato.');
      // atualizar estado local (usuarioLogado permanece o mesmo paciente)
      mostrarDashboard(usuarioLogado);
    };

    // mostrar perfil e preparar avaliação
    window.verPerfilFisio = function(fisioId) {
      const usuarioLogado = pegarUsuarioLogado();
      const usuarios = getUsuarios();
      const f = usuarios.find(u => u.id === fisioId);
      if (!f) return alert('Fisioterapeuta não encontrado.');

      // render detalhado no conteudoDinamico
      let html = `<div class="fisio-card">
        <h3>${f.nome}</h3>
        <div class="muted">Serviços: ${f.servicos.join(', ')}</div>
        <div class="muted">Endereço: ${f.endereco || 'Não informado'}</div>
        <div style="margin-top:8px;"><strong>Avaliação:</strong> ${calcularMediaAvaliacoes(f.avaliacoes).mediaFormat}</div>
        <div style="margin-top:8px;"><strong>Comentários:</strong></div>
        <div style="margin-top:8px;">${(f.avaliacoes && f.avaliacoes.length) ? f.avaliacoes.map(a => `<div style="margin-bottom:8px;"><strong>${a.pacienteNome}</strong> — ${a.nota}★<div style="font-size:13px;color:#444;">${a.comentario || ''}</div><div class="muted" style="font-size:12px;">${new Date(a.data).toLocaleString()}</div></div>`).join('') : '<div class="muted">Nenhum comentário ainda.</div>'}</div>
      </div>`;

      // se paciente logado, mostrar botão para avaliar (somente se já solicitou ao fisio)
      if (usuarioLogado && usuarioLogado.tipo === 'paciente') {
        const jaSolicitou = f.solicitacoes && f.solicitacoes.some(s => s.pacienteId === usuarioLogado.id);
        html += `<div style="margin-top:10px;">${jaSolicitou ? `<div class="muted">Você já solicitou atendimento a este fisioterapeuta e pode avaliá-lo.</div><div style="margin-top:8px;"><button class="orange-btn" id="btnAbrirAvaliacao">Avaliar ${f.nome}</button></div>` : `<div class="muted">Para avaliar, primeiro solicite atendimento.</div>`}</div>`;
      }
      conteudoDinamico.innerHTML = html;

      // preparar avaliação se botão existe
      const btnAbrir = document.getElementById('btnAbrirAvaliacao');
      if (btnAbrir) {
        btnAbrir.addEventListener('click', () => {
          fisioterapeutaVisualizando = f.id;
          avaliacaoContainer.classList.remove('hidden');
          // desmarcar estrelas
          Array.from(document.querySelectorAll('input[name="estrela"]')).forEach(i => i.checked = false);
          comentarioAvaliacao.value = '';
          // scroll pro container (se necessário)
        });
      }
    };

    // enviar avaliação
    btnEnviarAvaliacao.addEventListener('click', () => {
      const usuarioLogado = pegarUsuarioLogado();
      if (!usuarioLogado || usuarioLogado.tipo !== 'paciente') {
        alert('Apenas pacientes podem avaliar.');
        return;
      }
      const notaInput = document.querySelector('input[name="estrela"]:checked');
      if (!notaInput) return alert('Selecione uma quantidade de estrelas.');
      const nota = Number(notaInput.value);
      const comentario = comentarioAvaliacao.value.trim();

      const usuarios = getUsuarios();
      const idxF = usuarios.findIndex(u => u.id === fisioterapeutaVisualizando);
      if (idxF < 0) return alert('Fisioterapeuta não encontrado.');

      // verificar se paciente solicitou atendimento (só pode avaliar se solicitou)
      const f = usuarios[idxF];
      const solicitou = f.solicitacoes && f.solicitacoes.some(s => s.pacienteId === usuarioLogado.id);
      if (!solicitou) return alert('Somente pacientes que solicitaram atendimento podem avaliar este fisioterapeuta.');

      // adicionar avaliação
      const aval = {
        nota,
        comentario,
        pacienteId: usuarioLogado.id,
        pacienteNome: usuarioLogado.nome,
        data: new Date().toISOString()
      };
      usuarios[idxF].avaliacoes = usuarios[idxF].avaliacoes || [];
      usuarios[idxF].avaliacoes.push(aval);
      setUsuarios(usuarios);
      alert('Avaliação enviada — obrigada!');
      avaliacaoContainer.classList.add('hidden');
      comentarioAvaliacao.value = '';
      // atualizar visual
      mostrarDashboard(usuarioLogado);
    });

    btnCancelarAvaliacao.addEventListener('click', () => {
      avaliacaoContainer.classList.add('hidden');
      fisioterapeutaVisualizando = null;
      comentarioAvaliacao.value = '';
    });

    // marcar atendimento como atendido (remover solicitação)
    window.marcarComoAtendido = function(fisioId, pacienteId) {
      const usuarios = getUsuarios();
      const idxF = usuarios.findIndex(u => u.id === fisioId);
      if (idxF < 0) return alert('Fisioterapeuta não encontrado.');
      const fisio = usuarios[idxF];
      fisio.solicitacoes = (fisio.solicitacoes || []).filter(s => s.pacienteId !== pacienteId);
      setUsuarios(usuarios);
      // atualizar usuário logado caso seja o fisio
      const log = pegarUsuarioLogado();
      if (log && log.id === fisioId) salvarUsuarioLogado(usuarios[idxF]);
      mostrarDashboard(pegarUsuarioLogado());
    };

    /***********************
     * Logout e restauração
     ***********************/
    document.getElementById('btnLogout').addEventListener('click', () => {
      localStorage.removeItem('usuarioLogado');
      location.reload();
    });

    // carregar dashboard se já estiver logado
    window.addEventListener('load', () => {
      const user = pegarUsuarioLogado();
      if (user) {
        // atualizar com a versão mais atual dos dados salvos
        const usuarios = getUsuarios();
        const upt = usuarios.find(u => u.email === user.email);
        if (upt) {
          salvarUsuarioLogado(upt);
          mostrarDashboard(upt);
        } else {
          // nada, manter tela de cadastro/login
        }
      } else {
        // mostra cadastro (padrão)
      }
    });

    /***********************
     * Funções auxiliares
     ***********************/
    // mostrar alert de esqueci senha (simplesmente local, sem email)
    document.getElementById('esqueci').addEventListener('click', () => {
      const email = prompt('Digite seu email cadastrado para recuperar senha:');
      if (!email) return;
      const usuarios = getUsuarios();
      const u = usuarios.find(x => x.email === email.toLowerCase());
      if (!u) return alert('Email não encontrado.');
      alert(`Senha (apenas local): ${u.senha} — recomendamos alterar após lembrar.`);
    });

    // função util para atualizar usuarioLogado caso edite dados externamente
    function atualizarUsuarioLogadoPorEmail(email) {
      const usuarios = getUsuarios();
      const u = usuarios.find(x => x.email === email);
      if (!u) return null;
      salvarUsuarioLogado(u);
      return u;
    }

    // expor algumas funções para console/debug (opcional)
    window._DF = {
      getUsuarios,
      setUsuarios,
      salvarUsuarioLogado,
      pegarUsuarioLogado
    };

  </script>
</body>
</html>
